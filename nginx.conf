events {
    worker_connections 1024;
}

stream {
    # Define upstream servers (Citus coordinators)
    upstream citus_coordinators {
        # Round-robin load balancing
        server citus_coordinator1:5432 weight=1 max_fails=3 fail_timeout=30s;
        server citus_coordinator2:5432 weight=1 max_fails=3 fail_timeout=30s;
    }
    
    # PostgreSQL load balancer
    server {
        listen 5438;
        proxy_pass citus_coordinators;
        proxy_timeout 1s;
        proxy_responses 1;
        proxy_connect_timeout 1s;
    }
}

# HTTP block for status and monitoring
http {
    # Basic Nginx status page
    server {
        listen 8080;
        location / {
            return 200 "Nginx PostgreSQL Load Balancer - Status: Active\n";
            add_header Content-Type text/plain;
        }
    }
    
    server {
        listen 8081;
        location /nginx_status {
            stub_status on;
            access_log off;
            allow all;
        }
        
        location /health {
            return 200 "OK";
            add_header Content-Type text/plain;
        }
        
        location / {
            return 200 "Nginx Multi-Master Load Balancer - Monitoring Dashboard";
            add_header Content-Type text/plain;
        }
    }
} 